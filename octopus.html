<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>SmartAtHome.co.uk - My Octopus Usage</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="functions.js"></script>
<script>
var pagelink = location.origin+location.pathname;
user_info = check_login();
var account_no = user_info["account_no"];
var apikey = user_info["apikey"]
var logged_in = true;
if (account_no == "" || apikey == "" || account_no == null || apikey == null) {
	logged_in = false;
	gsp = getCookie("gsp");
	postcode = getCookie("postcode");
	if (gsp != ""){
		user_info["gsp"] = gsp
	} else {
		user_info["gsp"] = "average";
	}
	if (postcode != "") {
		user_info["postcode"] = postcode;
	}
};

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);

var startdate = new Date();
if (urlParams.has('start')) {
	var start = urlParams.get('start');
	startdate = parseDateParam(start)
} else {
	startdate.setDate(startdate.getDate() - 2);
	startdate.setHours(0, 0, 0, 0);
}

var enddate = new Date(startdate);
if (urlParams.has('end')) {
	var end = urlParams.get('end');
	enddate = parseDateParam(end)
} else {
	enddate.setDate(enddate.getDate() + 1);
}

if (startdate > enddate) {
	s2 = new Date(enddate);
	enddate = new Date(startdate);
	startdate = new Date(s2);
}

// subtract 1 second so as not to get the next period of data
if (enddate.getSeconds() == 0) {
	enddate.setSeconds(enddate.getSeconds()-1)
}

var consumptionDataPoints = [];
var consumption = null;

if (logged_in) {
	consumption = get_consumption(user_info, startdate, enddate);
	if (consumption.length > 0) {
		sortByKey(consumption, "interval_start");
		for (i in consumption) {
			var consumption_start = new Date(consumption[i]["interval_start"]).toISOString()
			consumptionDataPoints.push({x: consumption_start, y: consumption[i]["consumption"]});
		}
	}
}

function get_tariff_data(user_info, code, logged_in, consumption) {
	var dataPoints = [];
	var costs = "null";
	tariff_code = get_tariff_code(user_info, code)
	if (tariff_code != null) {
		unit_rates = get_30min_unit_rates(user_info, code, startdate, enddate, tariff_code);
		for (i in unit_rates) {
			dataPoints.push({x: unit_rates[i]["date"], y: unit_rates[i]["rate"]});
		}
		if (logged_in) {
			standing_charges = get_standing_charges(user_info, code, startdate, enddate, tariff_code);
			costs = get_costs_from_data(consumption, unit_rates, standing_charges);
		}
	}
	return { 'costs': costs, datapoints: dataPoints }
}

var go_data = get_tariff_data(user_info, go_code, logged_in, consumption);
var goDataPoints = go_data['datapoints'];
var go_costs = go_data['costs'];
var agile_data = get_tariff_data(user_info, agile_code, logged_in, consumption);
var agileDataPoints = agile_data['datapoints'];
var agile_costs = agile_data['costs'];

var carbon_intensity = get_carbon_intensity(startdate, enddate);
var intensityDataPoints = [];
for (i in carbon_intensity) {
	intensityDataPoints.push({x: carbon_intensity[i]["date"], y: carbon_intensity[i]["intensity"]});
}

carbon = 0;
if (logged_in) {
	carbon = get_carbon_from_data(consumption, carbon_intensity);
}

var dataSets = [
	{type: 'line', pointHitRadius:20, backgroundColor:'#ff0000', borderColor:'#ff0000', label:'Go Price', fill:false, steppedLine:true, yAxisID:'left', data:goDataPoints},
	{type: 'line', pointHitRadius:20, backgroundColor:'#00ff00', borderColor:'#00ff00', label:'Agile Price', fill:false, steppedLine:false, yAxisID:'left', data:agileDataPoints},
	{type: 'line', pointHitRadius:20, backgroundColor:'#800080', borderColor:'#800080', label:'Carbon Intensity', fill:false, yAxisID:'right2', data:intensityDataPoints, hidden: true}
];
if (consumptionDataPoints.length > 0) {
	dataSets.push({type: 'bar', backgroundColor:'#0000ff', label:'Consumption', fill:true, yAxisID:'right', data:consumptionDataPoints});
	rightAxis = true;
} else {
	rightAxis = false;
}

var config = {
	type: 'bar',
	data: { datasets: dataSets },
	options: {
		title: { display: false },
		tooltips: {
			mode: 'index',
			position: 'nearest',
			callbacks: {
				footer: function(tooltipItems, data) {
					var index = tooltipItems[0].index;
					if (data.datasets[3] != null && data.datasets[3].data[index] != null) {
						var go_cost = 0;
						var agile_cost = 0;
						var footprint = 0;
						tooltipItems.forEach(function(tooltipItem) {
							if (tooltipItem.datasetIndex == 0) {
								go_cost = tooltipItem.value * data.datasets[3].data[index].y;
							} else if (tooltipItem.datasetIndex == 1) {
								agile_cost = tooltipItem.value * data.datasets[3].data[index].y;
							} else if (tooltipItem.datasetIndex == 2) {
								footprint = tooltipItem.value * data.datasets[3].data[index].y;
							}
						});
						to_return = '';
						if (go_cost != 0) { to_return += 'Go cost: ' + go_cost.toFixed(2) + 'p\n'; }
						if (agile_cost != 0) { to_return += 'Agile cost: ' + agile_cost.toFixed(2) + 'p\n'; }
						if (footprint != 0) { to_return += 'Carbon footprint: ' + footprint.toFixed(1) + 'g'; }
						return to_return;
					}
				},
			},
			footerFontStyle: 'normal'
		},
		legend: {
			display: true,
			position: 'bottom',
			labels: { fontSize: 18, usePointStyle: true }
		},
		scales: {
			xAxes: [{
				type: 'time',
				time: { tooltipFormat: "DD-MM-YY HH:mm:ss" },
				display: true,
				scaleLabel: { display: false },
				offset: true
			}],
			yAxes: [
			{
				id: 'left',
				display: true,
				position: 'left',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Price (p/kWh)' }
			},
			{
				id: 'right2',
				display: true,
				position: 'right',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Carbon Intensity (gCO2/kWh)' },
				ticks: { suggestedMin: 0, suggestedMax: 350 }
			},
			{
				id: 'right',
				display: rightAxis,
				position: 'right',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Consumption (kWh)' }
			}
			]
		}
	}
};

var myChart = '';

window.onload = function() {
	document.getElementById("loginlink").setAttribute("href", "index.html"+window.location.search);
	var ctx = document.getElementById('myChart').getContext('2d');
	myChart = new Chart(ctx, config);
	if (logged_in) {
		document.getElementById('go_price').innerHTML = "£"+(go_costs/100).toFixed(2);
		document.getElementById('agile_price').innerHTML = "£"+(agile_costs/100).toFixed(2);
		document.getElementById('carbon1').innerHTML = (carbon).toFixed(1)+"g";
		document.getElementById('carbon2').innerHTML = (carbon).toFixed(1)+"g";
		document.getElementById("cost_table").style.display = "";
	} else {
		document.getElementById("not_logged_in").style.display = "";
		var postcode = getCookie("postcode");
		document.getElementById('postcode').value = postcode;
		var gsp = getCookie("gsp");
		if (gsp != "") {
			document.getElementById("region").value = gsp;
		} else if (postcode != "") {
			changePostcode();
		}
		document.getElementById('postcode').addEventListener("keyup", function(event) {
			if (event.key === "Enter") { changePostcode(); }
		});
	};
};

$(function() {
	$('input[name="datetimes"]').daterangepicker({
		timePicker: true,
		timePicker24Hour: true,
		timePickerSeconds: true,
		startDate: moment(startdate),
		endDate: moment(enddate),
		maxDate: moment().endOf('day').add(2, 'day'),
		locale: {
			format: ' DD/MM/YYYY HH:mm:ss'
		}
	}, function(start, end, label) {
		window.location.href = pagelink+"?start="+start.format('YYYY-MM-DDTHH:mm:ss')+"&end="+end.format('YYYY-MM-DDTHH:mm:ss');
	});
});

function changePostcode() {
	var pc = document.getElementById("postcode").value;
	user_info["postcode"] = pc;
	setCookie("postcode", pc, 365*24);
	var gsp = get_gsp(user_info);
	document.getElementById("region").value = gsp;
	changeRegion(gsp);
}

function changeRegion(val) {
	user_info['gsp'] = val;
	setCookie("gsp", val, 365*24);
	go_data = get_tariff_data(user_info, go_code, logged_in, consumption);
	config.data.datasets[0].data = go_data['datapoints'];
	agile_data = get_tariff_data(user_info, agile_code, logged_in, consumption);
	config.data.datasets[1].data = agile_data['datapoints'];
	myChart.update();
}

</script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

</head>
<body>
<br />
<center>
<input style="text-align:center;" size=50 type="text" name="datetimes" />
</center>
<br />
<div id='cost_table' style="display: none;">
<table class="w3-table-all w3-centered"><thead>
<tr class="w3-light-grey"><td><b>Octopus Tariff</b></td><td><b>Cost for this period</b></td><td><b>Your Carbon Footprint</b></td></tr></thead>
<tr><td>Go</td><td id="go_price"></td><td id="carbon1"></td></tr>
<tr><td>Agile</td><td id="agile_price"></td><td id="carbon2"></td></tr></table>
<br /></div>
<div id='not_logged_in' style="display:none;">
<center>
<a id="loginlink" href="index.html">Log in</a> to see your usage and compare tariffs.
Showing prices for <select id="region" onchange="changeRegion(this.value)">
<option value="average" selected="selected">National Average</option>
<option value="_A">East England</option>
<option value="_B">East Midlands</option>
<option value="_C">London</option>
<option value="_D">North Wales & Cheshire</option>
<option value="_E">West Midlands</option>
<option value="_F">North East England</option>
<option value="_G">North West England</option>
<option value="_H">Southern England</option>
<option value="_J">South East England</option>
<option value="_K">South Wales</option>
<option value="_L">South West England</option>
<option value="_M">Yorkshire</option>
<option value="_N">South Scotland</option>
<option value="_P">North Scotland</option>
</select>
or enter your postcode:
<input id="postcode" type="text"></input>
<br /><br /><b>Not with Octopus? Click <a href="https://share.octopus.energy/tidy-jay-1000">here</a> to join with £50 credit!</b>
</center></div>

<br />
<canvas id="myChart" width="800" height="300"></canvas>

<br /><br />
<center>

<input type='button' onClick='window.location.href=pagelink+"?start=-30days&end=now";' value='Last 30 days' style='font-size:15px;height:50px;width:100px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-7days&end=now";' value='Last 7 days' style='font-size:15px;height:50px;width:100px'>
<input type='button' onClick='future_prices();' value='Future prices' style='font-size:15px;height:50px;width:100px'>

</center><br />
</body>
</html>
