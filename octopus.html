<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Octopus Comparison</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="functions.js"></script>
<script>
var pagelink = location.origin+location.pathname;
user_info = check_login();
var account_no = user_info["account_no"];
var apikey = user_info["apikey"]
if (account_no == "" || apikey == "" || account_no == null || apikey == null) {
	window.location.replace("index.html");
};

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);

var startdate = new Date();
if (urlParams.has('start')) {
	var start = urlParams.get('start');
	startdate = parseDateParam(start)
} else {
	startdate.setDate(startdate.getDate() - 2);
	startdate.setHours(0, 0, 0, 0);
}

var enddate = new Date(startdate);
if (urlParams.has('end')) {
	var end = urlParams.get('end');
	enddate = parseDateParam(end)
} else {
	enddate.setDate(enddate.getDate() + 1);
}
// subtract 1 second so as not to get the next period of data
if (enddate.getSeconds() == 0) {
	enddate.setSeconds(enddate.getSeconds()-1)
}

var goDataPoints = [];
var agileDataPoints = [];
var consumptionDataPoints = [];

consumption = get_consumption(user_info, startdate, enddate);
if (consumption.length > 0) {
	sortByKey(consumption, "interval_start");
	for (i in consumption) {
		var consumption_start = new Date(consumption[i]["interval_start"]).toISOString()
		consumptionDataPoints.push({x: consumption_start, y: consumption[i]["consumption"]});
	}
}

var go_costs = "null";
go_tariff_code = get_tariff_code(user_info, go_code)
if (go_tariff_code != null) {
	go_unit_rates = get_30min_unit_rates(user_info, go_code, startdate, enddate, go_tariff_code);
	for (i in go_unit_rates) {
		goDataPoints.push({x: go_unit_rates[i]["date"], y: go_unit_rates[i]["rate"]});
	}
	go_standing_charges = get_standing_charges(user_info, go_code, startdate, enddate, go_tariff_code);
	go_costs = get_costs_from_data(consumption, go_unit_rates, go_standing_charges);
}

var agile_costs = "null";
agile_tariff_code = get_tariff_code(user_info, agile_code)
if (agile_tariff_code != null) {
	agile_unit_rates = get_30min_unit_rates(user_info, agile_code, startdate, enddate, agile_tariff_code);
	for (i in agile_unit_rates) {
		agileDataPoints.push({x: agile_unit_rates[i]["date"], y: agile_unit_rates[i]["rate"]});
	}
	agile_standing_charges = get_standing_charges(user_info, agile_code, startdate, enddate, agile_tariff_code);
	agile_costs = get_costs_from_data(consumption, agile_unit_rates, agile_standing_charges);
}

var carbon_intensity = get_carbon_intensity(startdate, enddate);
var intensityDataPoints = [];
for (i in carbon_intensity) {
	intensityDataPoints.push({x: carbon_intensity[i]["date"], y: carbon_intensity[i]["intensity"]});
}
carbon = get_carbon_from_data(consumption, carbon_intensity);

var dataSets = [];
dataSets.push({type: 'line', pointStyle:'line', backgroundColor:'#ff0000', borderColor:'#ff0000', label:'Go Price', fill:false, steppedLine:true, yAxisID:'left', data:goDataPoints});
dataSets.push({type: 'line', pointStyle:'line', backgroundColor:'#00ff00', borderColor:'#00ff00', label:'Agile Price', fill:false, steppedLine:true, yAxisID:'left', data:agileDataPoints});
dataSets.push({type: 'line', pointStyle:'line', backgroundColor:'#800080', borderColor:'#800080', label:'Carbon Intensity', fill:false, yAxisID:'right2', data:intensityDataPoints, hidden: true});
if (consumptionDataPoints.length > 0) {
	dataSets.push({type: 'bar', backgroundColor:'#0000ff', label:'Consumption', fill:true, yAxisID:'right', data:consumptionDataPoints});
	rightAxis = true;
} else {
	rightAxis = false;
}

var config = {
	type: 'bar',
	data: { datasets: dataSets },
	options: {
		title: { display: false },
		tooltips: {
			mode: 'index',
			position: 'nearest',
			callbacks: {
				footer: function(tooltipItems, data) {
					var index = tooltipItems[0].index;
					if (data.datasets[3] != null && data.datasets[3].data[index] != null) {
						var go_cost = 0;
						var agile_cost = 0;
						tooltipItems.forEach(function(tooltipItem) {
							if (tooltipItem.datasetIndex == 0) {
								go_cost = tooltipItem.value * data.datasets[3].data[index].y;
							} else if (tooltipItem.datasetIndex == 1) {
								agile_cost = tooltipItem.value * data.datasets[3].data[index].y;
							}
						});
						to_return = '';
						if (go_cost > 0) { to_return += 'Go cost: ' + go_cost.toFixed(2) + 'p\n'; }
						if (agile_cost > 0) { to_return += 'Agile cost: ' + agile_cost.toFixed(2) + 'p'; }
						return to_return;
					}
				},
			},
			footerFontStyle: 'normal'
		},
		legend: {
			display: true,
			position: 'bottom',
			labels: { fontSize: 18, usePointStyle: true }
		},
		scales: {
			xAxes: [{
				type: 'time',
				time: { tooltipFormat: "DD-MM-YY HH:mm:ss" },
				display: true,
				scaleLabel: { display: false }
			}],
			yAxes: [
			{
				id: 'left',
				display: true,
				position: 'left',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Price (p/kWh)' }
			},
			{
				id: 'right2',
				display: true,
				position: 'right',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Carbon Intensity (gCO2/kWh)' }
			},
			{
				id: 'right',
				display: rightAxis,
				position: 'right',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Consumption (kWh)' }
			}
			]
		}
	}
};

window.onload = function() {
	var ctx = document.getElementById('myChart').getContext('2d');
	var myChart = new Chart(ctx, config);
	document.getElementById('go_price').innerHTML = "£"+(go_costs/100).toFixed(2);
	document.getElementById('agile_price').innerHTML = "£"+(agile_costs/100).toFixed(2);
	document.getElementById('carbon1').innerHTML = (carbon).toFixed(1)+"g";
	document.getElementById('carbon2').innerHTML = (carbon).toFixed(1)+"g";
};

$(function() {
	$('input[name="datetimes"]').daterangepicker({
		timePicker: true,
		timePicker24Hour: true,
		timePickerSeconds: true,
		startDate: moment(startdate),
		endDate: moment(enddate),
		maxDate: moment().endOf('day').add(2, 'day'),
		locale: {
			format: ' DD/MM/YYYY HH:mm:ss'
		}
	}, function(start, end, label) {
		window.location.href = pagelink+"?start="+start.format('YYYY-MM-DDTHH:mm:ss')+"&end="+end.format('YYYY-MM-DDTHH:mm:ss');
	});
});

</script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
</head>
<body>
<br />
<center>
<input style="text-align:center;" size=50 type="text" name="datetimes" />
</center>
<br />
<table class="w3-table-all w3-centered"><thead>
<tr class="w3-light-grey"><td><b>Octopus Tariff</b></td><td><b>Cost for this period</b></td><td><b>Your Carbon Footprint</b></td></tr></thead>
<tr><td>Go</td><td id="go_price"></td><td id="carbon1"></td></tr>
<tr><td>Agile</td><td id="agile_price"></td><td id="carbon2"></td></tr></table>
<br /><br />

<canvas id="myChart" width="800" height="300"></canvas>

<br /><br />
<center>

<input type='button' onClick='window.location.href=pagelink+"?start=-30days&end=now";' value='Last 30 days' style='font-size:15px;height:50px;width:100px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-7days&end=now";' value='Last 7 days' style='font-size:15px;height:50px;width:100px'>
<input type='button' onClick='future_prices();' value='Future prices' style='font-size:15px;height:50px;width:100px'>

</center><br />
</body>
</html>
