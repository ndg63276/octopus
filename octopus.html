<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Octopus Comparison</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
<script src="functions.js"></script>
<script>
var pagelink = location.origin+location.pathname;
user_info = check_login();
var account_no = user_info["account_no"];
var apikey = user_info["apikey"]
if (account_no == "" || apikey == "") {
	window.location.replace("index.html");
};

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);

var startdate = new Date();
if (urlParams.has('start')) {
	var start = urlParams.get('start');
	startdate = parseDateParam(start)
} else {
	startdate.setDate(startdate.getDate() - 1);
}

var enddate = new Date();
if (urlParams.has('end')) {
	var end = urlParams.get('end');
	enddate = parseDateParam(end)
	// subtract 1 second so as not to get the next period of data
	enddate.setSeconds(enddate.getSeconds()-1)
}

if (startdate.getFullYear() === enddate.getFullYear() &&
	startdate.getMonth() === startdate.getMonth() &&
	startdate.getDate() === enddate.getDate()) {
		var tooltipFormat="HH:mm:ss";
} else {
		var tooltipFormat="DD-MM-YY HH:mm:ss";
}

go_tariff_code = get_tariff_code(user_info, go_code)
go_unit_rates = get_30min_unit_rates(user_info, go_code, startdate, enddate, go_tariff_code);
var goDataPoints = [];
for (i in go_unit_rates) {
	goDataPoints.push({x: go_unit_rates[i]["date"], y: go_unit_rates[i]["rate"]});
}
go_standing_charges = get_standing_charges(user_info, go_code, startdate, enddate, go_tariff_code);

agile_tariff_code = get_tariff_code(user_info, agile_code)
agile_unit_rates = get_30min_unit_rates(user_info, agile_code, startdate, enddate, agile_tariff_code);
var agileDataPoints = [];
for (i in agile_unit_rates) {
	agileDataPoints.push({x: agile_unit_rates[i]["date"], y: agile_unit_rates[i]["rate"]});
}
agile_standing_charges = get_standing_charges(user_info, agile_code, startdate, enddate, agile_tariff_code);

consumption = get_consumption(user_info, startdate, enddate);
var consumptionDataPoints = [];
for (i in consumption) {
	consumptionDataPoints.push({x: consumption[i]["interval_start"], y: consumption[i]["consumption"]});
}

go_costs = get_costs_from_data(consumption, go_unit_rates, go_standing_charges)
agile_costs = get_costs_from_data(consumption, agile_unit_rates, agile_standing_charges)

var dataSets = [];
dataSets.push({type: 'line', pointStyle:'line', borderColor:'#ff0000', label:'Go Price', fill:false, steppedLine:true, yAxisID:'left', data:goDataPoints});
dataSets.push({type: 'line', pointStyle:'line', borderColor:'#00ff00', label:'Agile Price', fill:false, steppedLine:true, yAxisID:'left', data:agileDataPoints});
dataSets.push({type: 'bar', backgroundColor:'#0000ff', label:'Consumption', fill:true, yAxisID:'right', data:consumptionDataPoints});

var config = {
	type: 'bar',
	data: { datasets: dataSets },
	options: {
		title: { display: false },
		legend: {
			display: true,
			position: 'bottom',
			labels: { fontSize: 18, usePointStyle: true }
		},
		scales: {
			xAxes: [{
				type: 'time',
				time: { tooltipFormat: tooltipFormat },
				display: true,
				scaleLabel: { display: false }
			}],
			yAxes: [
			{
				id: 'left',
				display: true,
				position: 'left',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Price (p/kWh)' }
			},
			{
				id: 'right',
				display: true,
				position: 'right',
				type: 'linear',
				scaleLabel: { display: true, labelString: 'Consumption (kWh)' }
			}
			]
		}
	}
};

window.onload = function() {
	var ctx = document.getElementById('myChart').getContext('2d');
	var myChart = new Chart(ctx, config);
	document.getElementById('go_price').innerHTML = "£"+(go_costs/100).toFixed(2);
	document.getElementById('agile_price').innerHTML = "£"+(agile_costs/100).toFixed(2);
};

</script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<body>
<table class="w3-table-all w3-centered"><thead><tr class="w3-light-grey"><td><b>Octopus Tariff</b></td><td><b>Cost for this period</b></td></tr></thead>
<tr><td>Go</td><td id="go_price"></td></tr>
<tr><td>Agile</td><td id="agile_price"></td></tr></table>
<br /><br />

<canvas id="myChart" width="800" height="400"></canvas>

<br /><br /><center><form>
<input type='button' onClick='window.location.href=pagelink+"?start=-1hour&end=now";' value='Last 1 hour' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-12hours&end=now";' value='Last 12 hours' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.reload(true);' value='Refresh' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-24hours&end=now";' value='Last 24 hours' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-7days&end=now";' value='Last 7 days' style='font-size:20px;height:100px;width:200px'>

</form></center><br />
</body>
</html>
